syntax = "proto3";
package lobbies;
option go_package = "lobbies/proto";
option csharp_namespace = "Battlegrounds.Proto.Lobbies";

// This proto file defines the gRPC service and messages for managing game lobbies, including hosting, joining, updating lobby state, sending chat messages, leaving the lobby, launching the game, reporting game status, and changing the map. 
// The service allows for real-time updates to be broadcasted to all participants in the lobby whenever a relevant event occurs.
// All RPC methods require an authorization token to identify the participant making the request, and the lobby ID is expected to be provided in the metadata for methods that operate on a specific lobby.
service LobbyService {

    // Allows a participant to host a new lobby, which will trigger updates to other participants about the new lobby and its initial state.
    rpc HostLobby(HostLobbyRequest) returns (stream LobbyStateUpdate);

    // Allows a participant to join an existing lobby, which will trigger updates to other participants in the lobby about the new participant and their assigned slot.
    rpc JoinLobby(JoinLobbyRequest) returns (stream LobbyStateUpdate);

    // Allows the host to remove a participant from the lobby, which will trigger updates to other participants in the lobby about the removed participant and their freed slot.
    rpc RemoveParticipant(RemoveParticipantRequest) returns (Empty);

    // Allows the host or participants to update the lobby state, which will be broadcasted to all other participants in the lobby. This can include changes to team compositions, lobby settings, or other relevant information.
    rpc UpdateLobbyState(LobbyStateUpdate) returns (Empty);

    // Allows participants to send chat messages within the lobby, which will be broadcasted to all other participants in the lobby.
    rpc SendChatMessage(ChatMessage) returns (Empty);

    // Allows a participant to leave the lobby, which will trigger updates to other participants and free up their slot for others to join.
    rpc LeaveLobby(LeaveLobbyRequest) returns (Empty);

    // Initiates the launching of the game for all lobby participants.
    rpc LaunchGame(LaunchGameRequest) returns (Empty);

    // Reports the end-of-match status back to the lobby, which can be used for post-game processing and analytics
    rpc ReportGameStatus(ReportGameStatusRequest) returns (Empty);

    // Changes the map for the lobby    
    rpc ChangeMap(ChangeMapRequest) returns (ChangeMapResponse);

    // Initiates a download sequence for all participants in the lobby and streams progress updates
    rpc BeginInitiateDownload(InitiateDownloadRequest) returns (stream DownloadState);

    // Initialise a download for all participants but the host will not care about the progress
    rpc InitiateDownload(InitiateDownloadRequest) returns (Empty);

    // Reports download progress from a participant
    rpc ReportDownloadProgress(ReportDownloadProgressRequest) returns (Empty);

    // Begins the match (freezes the lobby and prevents further changes, allowing the game to start)
    rpc BeginMatch(Empty) returns (Empty);

    // Ends the match (resets the lobby and allows participants to return to the lobby state)
    rpc EndMatch(Empty) returns (Empty);

}

// The HostLobbyRequest message contains the necessary information for a participant to host a new lobby, including the host's ID, lobby name, optional password for protected lobbies, initial lobby settings as key-value pairs, and the associated game ID.
message HostLobbyRequest {
    string lobby_name = 1;
    optional string password = 2;
    map<string, string> settings = 3;
    string game_id = 4;
}

// The JoinLobbyRequest message contains the necessary information for a participant to join an existing lobby, including the lobby ID and an optional password if the lobby is protected.
message JoinLobbyRequest {
    string lobby_id = 1;
    string password = 2; // Optional, leave empty if the lobby does not require a password
}

// The LeaveLobbyRequest message is an empty message that can be used when a participant wants to leave the lobby. It does not require any parameters since the server can identify the participant based on the connection context.
// The caller is expected to define the lobby id using the metadata key x-lobby-id. The participant id is extracted from the authorization token, so it is not necessary to include it in the message itself.
message LeaveLobbyRequest {}

// The RemoveParticipantRequest message contains the necessary information for the host to remove a participant from the lobby, including the target participant's ID and an optional reason for removal that can be used for logging or notifications.
// The caller is expected to define the lobby id using the metadata key x-lobby-id. The host's participant id is extracted from the authorization token, so it is not necessary to include it in the message itself.
message RemoveParticipantRequest {
    string target_participant_id = 1; // The participant to be removed
    string reason = 2; // Optional reason for removal, can be used for logging or notifications
}

// The LaunchGameRequest message is an empty message that can be used to initiate the launching of the game for all lobby participants. It does not require any parameters since the server can identify the host and lobby based on the connection context.
// The caller is expected to define the lobby id using the metadata key x-lobby-id. The host's participant id is extracted from the authorization token, so it is not necessary to include it in the message itself.
message LaunchGameRequest {}

// The ReportGameStatusRequest message contains the necessary information for a participant to report the end-of-match status back to the lobby, which can be used for post-game processing and analytics. The status field can indicate whether the match was started, finished, or if there was an error.
// The caller is expected to define the lobby id using the metadata key x-lobby-id. The participant id is extracted from the authorization token, so it is not necessary to include it in the message itself.
message ReportGameStatusRequest {
    string status = 1; // e.g., "started", "finished", "error"
}

// The LobbyStateUpdate message is a versatile message that can represent various types of updates to the lobby state, including changes to slots, lobby settings, team compositions, chat messages, and more. 
// The event_type field indicates the type of event that triggered the update (e.g., "slot_update", "settings_update", "team_update", "chat_message", "lobby_state", "participant_update", "system_message", "download_state"), and the oneof change field allows for different types of updates to be included in the same message structure, making it flexible for broadcasting various changes to all participants in the lobby.
// When a participant joins the lobby, they will receive a LobbyStateUpdate with the event_type "lobby_state" that contains the full state of the lobby, including all teams, slots, participants, and settings. This allows the new participant to synchronize their view of the lobby with the current state.
// For other events, such as a slot update or a chat message, the event_type will indicate the specific type of update, and the corresponding field in the oneof change will contain the relevant information for that update. This allows for efficient broadcasting of specific changes without needing to send the entire lobby state every time.
// Note: For team updates, the Slot field will be ignored since there is a separate SlotUpdate message for slot-specific changes. The Team message will focus on changes to the team composition, such as adding or removing participants from a team, or changing the team's alias or type.
// The Empty message can be used in cases where no specific change is made to the lobby state, but an update still needs to be broadcasted (e.g., when a participant leaves the lobby, the event_type can be "participant_update" with an empty change to indicate that a participant has left without needing to specify which participant).
// The SystemMessage can be used for broadcasting system-wide notifications or errors that are not specific to a particular participant or slot, such as server maintenance announcements, error messages, or other important information that all participants should be aware of.
// The DownloadState can be used for broadcasting updates related to download progress for resources such as maps or mods, allowing participants to see the progress of downloads for themselves and other participants in the lobby.
// Overall, the LobbyStateUpdate message provides a flexible and efficient way to communicate various types of updates to all participants in the lobby, ensuring that everyone stays informed about changes to the lobby state in real-time.
// Note: For certain updates, such as a slot update or a chat message, the event_type will indicate the specific type of update, and the corresponding field in the oneof change will contain the relevant information for that update. This allows for efficient broadcasting of specific changes without needing to send the entire lobby state every time.
// Example usage:
// When a participant joins the lobby, they will receive a LobbyStateUpdate with the event_type "lobby_state" that contains the full state of the lobby, including all teams, slots, participants, and settings. This allows the new participant to synchronize their view of the lobby with the current state.
// For other events, such as a slot update or a chat message, the event_type will indicate the specific type of update, and the corresponding field in the oneof change will contain the relevant information for that update. This allows for efficient broadcasting of specific changes without needing to send the entire lobby state every time.
// The caller is expected to define the lobby id using the metadata key x-lobby-id for methods that operate on a specific lobby, and the participant id is extracted from the authorization token, so it is not necessary to include it in the message itself for those cases.
message LobbyStateUpdate {
    string event_type = 1;
    string sender_id = 2; // Assigned by the server based on the participant's authorization token, included here for broadcasting to other participants
    oneof change {
        SlotUpdate slot_update = 3;
        LobbySetting settings_update = 4;
        Team team_update = 5; // Note, this will ignore the "Slot" field since there's a separate message for slots
        ChatMessage chat_message = 6;
        Lobby lobby_state = 7;
        Participant participant_update = 8; // For updates related to participants joining, leaving, or being removed from the lobby
        Empty empty = 9; // For cases where no specific change is made
        SystemMessage system_message = 10; // For system-wide notifications or errors
        DownloadState download_state = 11; // For download progress updates
        string lobby_id = 12; // For updates the initial lobby creation, so the host can be informed of the lobby ID that was created
    }
}

// The SlotUpdate message represents a change to a specific slot within a team, including the team ID and the updated slot information.
message SlotUpdate {
    int32 team_id = 1;
    Slot slot = 2; // Updated slot information
}

// The Lobby message represents the current state of the lobby, including its ID, name, host, teams, participants, settings, and associated game ID. 
// This message can be used to broadcast the entire lobby state to participants whenever a significant change occurs (e.g., a new participant joins, a participant leaves, or the host updates lobby settings).
message Lobby {
    string id = 1;
    string name = 2;
    string host_id = 3;
    repeated Team teams = 4;
    repeated Participant participants = 5;
    map<string, string> settings = 6; // Key-value pairs for lobby settings
    string game_id = 7;
}

// The LobbySetting message represents a change to a specific lobby setting, including the key of the setting being changed, its old value (if applicable), and its new value. 
// This message can be used to broadcast specific setting changes to participants without needing to send the entire lobby state, allowing for more efficient updates when only a single setting is modified.
message LobbySetting {
    string key = 1;
    string old_value = 2; // Optional, can be empty if not applicable
    string new_value = 3;
}

// The Team message represents a team within the lobby, including its ID, alias, type (e.g., "human", "AI", "spectator"), and the slots assigned to that team.
message Team {
    int32 id = 1;
    string alias = 2;
    string type = 3;
    repeated Slot slots = 4;
}

// The Slot message represents a specific slot within a team, including its ID, the participant assigned to that slot (if any), the faction chosen by the participant, the company ID (if applicable), the AI difficulty level (if applicable), and whether the slot is hidden or locked.
message Slot {
    int32 id = 1;
    optional string participant_id = 2;
    string faction = 3;
    optional string company_id = 4;
    optional string ai_difficulty = 5;
    bool hidden = 6;
    bool locked = 7;
}

// The Participant message represents a participant in the lobby, including their ID, name, whether they are an AI participant, and whether they are ready to start the game.
message Participant {
    string participant_id = 1;
    string name = 2;
    bool is_ai = 3;
    bool ready = 4;
}

// The ChatMessage message represents a chat message sent by a participant within the lobby, including the lobby ID, sender's participant ID, the channel the message was sent in (e.g., "general", "team"), and the content of the message.
// The caller is expected to define the lobby id using the metadata key x-lobby-id for methods that operate on a specific lobby, and the participant id is extracted from the authorization token, so it is not necessary to include it in the message itself for those cases. However, including the channel and content allows for proper broadcasting of chat messages to other participants in the lobby.
message ChatMessage {
    string channel = 1;
    string content = 2;
    string sender_id = 3; // Assigned by the server based on the participant's authorization token, included here for broadcasting to other participants
}

// The SystemMessage message represents a system-wide notification or error that can be broadcasted to all participants in the lobby, including a message type (e.g., "info", "warning", "error") and the content of the message.
// This message can be used for important announcements, error messages, or other information that all participants should be aware of, regardless of their specific role or participation in the lobby.
// The caller is expected to define the lobby id using the metadata key x-lobby-id for methods that operate on a specific lobby, and the participant id is extracted from the authorization token, so it is not necessary to include it in the message itself for those cases. However, including the message type and content allows for proper broadcasting of system messages to all participants in the lobby.
message SystemMessage {
  string message_type = 1; // e.g., "info", "warning", "error"
  string content = 2;
}

// The ChangeMapRequest message contains the necessary information for a participant to request a change of the map for the lobby, including the lobby ID, participant ID, and the new map information (map ID and maximum number of players).
message PlayMap {
    string map_id = 1;
    int32 max_players = 2;
}

// The ChangeMapResponse message contains the response to a ChangeMapRequest, indicating whether the map change was successful and providing an error reason if it was not successful (e.g., map not found, insufficient permissions).
// The caller is expected to define the lobby id using the metadata key x-lobby-id for methods that operate on a specific lobby, and the participant id is extracted from the authorization token, so it is not necessary to include it in the message itself for those cases. However, including the new map information allows for proper processing of the map change request and broadcasting of the new map information to all participants in the lobby if the change is successful.
message ChangeMapRequest {
    PlayMap new_map = 1;
}

// The ChangeMapResponse message contains the response to a ChangeMapRequest, indicating whether the map change was successful and providing an error reason if it was not successful (e.g., map not found, insufficient permissions).
message ChangeMapResponse {
    bool success = 1;
    int32 error_reason = 2; // 0 for no error, other values can represent specific errors (e.g., 1 for map not found, 2 for insufficient permissions)
}

// The InitiateDownloadRequest message contains the necessary information for a participant to initiate a download sequence for a specific resource (e.g., map, mod) for all participants in the lobby. The resource_id field identifies the resource to be downloaded, and the server will handle the initiation of the download process and broadcasting of progress updates to all participants in the lobby.
message InitiateDownloadRequest {
    string resource_id = 1; // Identifier for the resource to download (e.g., map ID, mod ID)
}

// The ReportDownloadProgressRequest message contains the necessary information for a participant to report their download progress for a specific resource back to the server, which can then broadcast this information to all participants in the lobby. The progress field indicates the percentage of the download completed (from 0.0 to 100.0), and the completed field indicates whether the download has been completed by the participant.
message ReportDownloadProgressRequest {
    float progress = 1; // Progress percentage (0.0 to 100.0)
    bool completed = 2; // Whether the download is complete
}

// The DownloadStatus message represents the download status of a specific participant for a given resource, including the participant's ID, their current progress percentage, and whether they have completed the download. This information can be used to track the download progress of each participant in the lobby and provide updates to all participants about the overall download status.
message DownloadStatus {
    string participant_id = 1;
    float progress = 2; // Progress percentage (0.0 to 100.0)
    bool completed = 3; // Whether the participant has completed the download
}

// The DownloadState message represents the overall download state for a specific resource in the lobby, including the resource ID, the download status of each participant, and whether all participants have completed the download. This information can be used to provide real-time updates to all participants about the progress of downloads for resources such as maps or mods, allowing them to see how their own progress compares to others in the lobby and when everyone has completed the necessary downloads.
message DownloadState {
    string resource_id = 1;
    repeated DownloadStatus participant_status = 2; // Status for each participant
    bool all_completed = 3; // Whether all participants have completed the download
}

// An empty message that can be used for RPC methods that do not require any parameters or return values, or as a placeholder when no specific change is made in a LobbyStateUpdate.
message Empty {}
